<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Grid Renderer</title>
  <style>
    .inputArea { width: 200px; height: 300px; }
    .canvas { border: 1px solid black; }
    .slider-container { margin-bottom: 10px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }

    .mode-badge { display: inline-block; padding: 4px 8px; margin: 2px; border-radius: 4px; color: #fff; font-size: 14px; font-weight: bold; font-family: Arial, sans-serif; }
    .numeric { background-color: #4CAF50; }
    .alphanumeric { background-color: #2196F3; }
    .byte { background-color: #f44336; }
    .encoded-mode { background: #ffdddd; }
    .encoded-length { background: #ddddff; }
    .encoded-data { background: #ddffdd; }
    .encoded-padding { background: #dddddd; }
    .encoded-ecc { background: #ffbbbb; }

    .error-correction-button {
      padding: 5px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      background-color: #e0e0e0;
      color: #000;
      transition: background-color 0.15s, color 0.15s;
    }
    .selected {
      background-color: #007BFF;
      color: #fff;
    }
  </style>
  <script src="layers.js"></script>
  <script src="qrcode.js"></script>
  <script src="encoding.js"></script>
</head>
<body>
  <div class="grid-container">
    <h2>Size, Finding Patters, and Timing</h2>
    <label for="size-value">Size</label> <input id="size-slider" type="range" min="1" max="40" value="6" step="1">
    <p id="size-value">Current Size: 6</p>
    <textarea class="inputArea sizeLayer" hidden="true"></textarea> <canvas class="canvas sizeCanvas"></canvas>
  </div>
  <div class="grid-container">
    <h2>Data Encoding</h2>
    <!-- Add four selectable buttons here for Error Correction Level: "Low", "Medium", "Quartile", "High" -->
    <!-- only one can be selected at a time -->
    <div id="errorCorrectionLevel">
      <button class="error-correction-button selected" data-level="L">Low (L)</button>
      <button class="error-correction-button" data-level="M">Medium (M)</button>
      <button class="error-correction-button" data-level="Q">Quartile (Q)</button>
      <button class="error-correction-button" data-level="H">High (H)</button>
    </div>
    <!-- Encoding Section -->
    <div class="section" id="encodeContainer">
        <textarea id="inputText" placeholder="Enter your text here"></textarea>
        <!-- On change, this should estimate its encoded length, determine minimum qr size, and update radio buttons with the version number -->
        <!-- Then for the selected Error Correction Level, call the encoding to show the encoding strings below -->
        <div id="outputContainer">
            <h3>Encoded Binary String</h3>
            <tt id="binaryOutput" readonly></tt>
            <!-- The binaryOutput should show the encoded string colored and delimited by codewords -->
            <!-- Followed by another split up by bytes and with padding -->
            <!-- Followed by a third, split into groups, with error correcting codes appended (not implemented yet) -->
            <div id="modeDisplay"><strong>Encoding Modes Used:</strong> <span id="modeUsed"></span></div>
        </div>
    </div>

    <textarea class="inputArea encodingLayer" hidden="true"></textarea> <canvas class="canvas encodingCanvas" hidden="true"></canvas>
  </div>
  <div class="grid-container">
    <h2>Error Correction</h2>
    <label>Level</label> <input type="radio" values="0,1,2,3" selected="0">
    <!-- 0: "L (low)", 1: "M (medium)", 2: "Q (quartile)", 3: "H (high)" --> <p>Current Level: L (low)</p>
    <textarea class="inputArea correctionLayer"></textarea> <canvas class="canvas correctionCanvas"></canvas>
  </div>
  <div class="grid-container">
    <h2>Data Masking</h2>
    <textarea class="inputArea maskingLayer"></textarea> <canvas class="canvas maskingCanvas"></canvas>
  </div>
  <div class="grid-container">
    <h2>Final Combined</h2>
    <textarea class="inputArea finalLayer"></textarea> <canvas class="canvas finalCanvas"></canvas>
  </div>

  <script>
    const cellSize = 6;
    const layers = [
      { input: document.querySelector('.inputArea.sizeLayer'), canvas: document.querySelector('.canvas.sizeCanvas') },
      { input: document.querySelector('.inputArea.encodingLayer'), canvas: document.querySelector('.canvas.encodingCanvas') },
      { input: document.querySelector('.inputArea.correctionLayer'), canvas: document.querySelector('.canvas.correctionCanvas') },
      { input: document.querySelector('.inputArea.maskingLayer'), canvas: document.querySelector('.canvas.maskingCanvas') },
      { input: document.querySelector('.inputArea.finalLayer'), canvas: document.querySelector('.canvas.finalCanvas') }
    ];

    // Attach individual event listeners to each input
    layers.forEach((layer, index) => {
      layer.input.addEventListener('input', drawCombinedGrid);
      layer.input.addEventListener('select', drawCombinedGrid);
      layer.input.addEventListener('mouseup', drawCombinedGrid);
      layer.input.addEventListener('keyup', drawCombinedGrid);
    });

    function updateVersion() {
      const sizeValueElement = document.getElementById('size-value');
      const version = parseInt(this.value) || 6;
      sizeValueElement.textContent = 'Current Version (Size): ' + version;
      
      const gridPattern = drawConstantPatterns(version);

      layers[0].input.value = gridPattern.map(row=>row.join('')).join('\n');
      drawCombinedGrid(); // Trigger an update after changing the text area
    };
    document.getElementById('size-slider').addEventListener('input', updateVersion);
    updateVersion();

    function displayMode(mode) {
      // Clear previous mode
      modeUsed.innerHTML = '';

      // Create a badge for the current mode
      const span = document.createElement('span');
      span.className = `mode-badge ${mode.toLowerCase()}`;
      span.textContent = mode;
      modeUsed.appendChild(span);
    }

    function updateEncodedText() {
      const inputText = document.getElementById('inputText');
      const binaryOutput = document.getElementById('binaryOutput');
      const modeUsed = document.getElementById('modeUsed');
      const errorCorrectionLevel = document.querySelector('.error-correction-button.selected').dataset.level;

      const version = Number(document.getElementById('size-slider').value) || 6;
      const { encodingMode, binaryString, segments } = getAutomaticEncoding(inputText.value, version, errorCorrectionLevel);
      if (segments) {
        binaryOutput.innerHTML = segments.map(({type,content,description})=>`<span class="encoded-${type}" title="${type} (${encodeURIComponent(description)})">${content}</span>`).join(" ");
      } else {
        binaryOutput.innerHTML = binaryString;
      }
      displayMode(encodingMode);
    }

    document.getElementById('inputText').addEventListener('input', updateEncodedText);

    document.querySelectorAll('.error-correction-button').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.error-correction-button').forEach(btn => btn.classList.remove('selected'));
        this.classList.add('selected');
        updateEncodedText();
      });
    });
  </script>
</body>
</html>